<!DOCTYPE HTML>

<html>
    <head>
        <meta name="viewport" value="width=device-width, initial-scale=1.0, user-scalable=yes">
        <meta name="description" value="# Telegram Bot and Something (WIP)

One of my friend asked for a help.
Though this time from a different person and on different problem.
We are going to build a bot for Telegram instant messenger ser">
        <meta name="author" value="Ibnu D. Aji">
        <link rel="stylesheet" type="text/css" href="static/css/milligram.min.css">
        <title>
            Nothing Unusual - Telegram Bot and Something
        </title>
    </head>
    <body>
        <main class="wrapper">
            <nav class="navigation">
                <section class="container">
                    <a class="navigation-title" href="index.html">
                        Home
                    </a>
                    <ul class="navigation-list float-right">
                        <li class="navigation-item">
                            <a href="2018-01-01-about.html" class="navigation-link">
                                About
                            </a>
                        </li>
                    </ul>
                </section>
            </nav>
            <section class="container">
                <h1>Telegram Bot and Something (WIP)</h1><p>One of my friend asked for a help.
Though this time from a different person and on different problem.
We are going to build a bot for Telegram instant messenger service which talks to database.
For the sake of giving an example, let's say that we will create a telegram bot which
records the income and expense.
Trust me, it's really hairy and ugly.</p><p>Okay, let's start the mess.</p><h3>Preparation</h3><p>Just type <code>stack new OurBot new-template</code> into your terminal and then modify <code>stack.yaml</code>.
Insert the following lines in it</p><pre><code># stack.yaml
packages:
- .
- location:
    git: https://github.com/fizruk/telegram-bot-simple
    commit: c1cc6bbba14ca79c897586e2de28433193c0b9fd
  extra-dep: true
</code></pre><p>Which means that we will use that git repo (on that specified commit) on our program.
As for the reason, I've failed to compile <a href="https://hackage.haskell.org/package/telegram-api"><code>telegram-api</code></a>
in the server I'm deploying to.</p><p>And then we will modify <code>package.yaml</code> to include the repo above as our dependency.</p><pre><code># package.yaml
dependencies:
- base &gt;= 4.7 &amp;&amp; &lt; 5
- telegram-bot-simple
</code></pre><p>Where <code>telegram-bot-simple</code> is the name of the library which we previously included
in our <code>stack.yaml</code>.</p><p>Let's build it for a giggle by issuing <code>stack build</code> at the project's root directory.
It should compile just fine, I guess.</p><p>Next, we will create our domain model.</p><h3>Database Thingy</h3><p>We will add a few dependencies on our <code>package.yaml</code>.</p><ul><li><code>persistent</code> for talking to database.</li><li><code>persistent-postgresql</code> for talking to postgresql, specifically.</li><li><code>persistent-template</code>, it eases our life a bit. Though prolong the compile time.</li><li><code>esqueleto</code> it's nice to join the tables in a <del>bar</del> database.</li><li><code>text</code>, I just like <code>Text</code>.</li></ul><p>Then, we will create a file named <code>Model.hs</code> in our <code>src</code> directory and include it
as one of our source files.</p><p>To simplify a bit, we will create two tables named <code>income</code> and <code>expense</code>.
The <code>income</code> table will have <code>source</code> (<code>Text</code>) and <code>amount</code> (<code>Double</code>) while <code>expense</code>
table will have <code>towhom</code> (<code>Text</code>), and <code>amount</code> (<code>Double</code>)</p><p>In order to accomplish that, we will edit <code>Model.hs</code> as the following</p><pre><code>-- Model.hs
{-# LANGUAGE ExistentialQuantification #-}
{-# LANGUAGE GADTs #-}
{-# LANGUAGE GeneralizedNewtypeDeriving #-}
{-# LANGUAGE MultiParamTypeClasses #-}
{-# LANGUAGE QuasiQuotes #-}
{-# LANGUAGE TemplateHaskell #-}
{-# LANGUAGE TypeFamilies #-}
module Model where

import Data.Text
import Database.Persist.TH
import Database.Persist.Sql

share
  [mkPersist sqlSettings, mkMigrate &quot;migrateAll&quot;]
  [persistLowerCase|
    Income
      source Text
      amount Double
      deriving Show Eq
    Expense
      towhom Text
      amount Double
      deriving Show Eq
  |]
</code></pre><p>At the second glance, I just realized that we use so many language extensions.
As for the reasons, apart from <code>QuasiQuotes</code> and <code>TemplateHaskell</code>, I don't really
know and just accept that GHC will complain without them.
But if you insist, you can look at the <a href="http://downloads.haskell.org/~ghc/latest/docs/html/users_guide/glasgow_exts.html">docs</a>
about them.</p><p>Anyway, the snippet above, especially the <code>share</code> block, defines that we will
create tables name <code>income</code> and <code>expense</code>, which we have specified before the snippet.</p><p>And for the &quot;migration plan&quot;, just a fancy way to say about creating and/or dropping
tables and/or database before the program talks to it, we will create a function
named <code>doMigration</code> in the same source file.</p><pre><code>-- Model.hs
doMigration :: SqlPersistT IO ()
doMigration = runMigration migrateAll
</code></pre><p>If you wonder where did <code>migrateAll</code> come from, that value comes from the
<code>share</code> block above.
You can see <code>&quot;migrateAll&quot;</code> there. That's the magic of <code>Template Haskell</code>.</p>
            </section>
        </main>
    </body>
    <footer>
        This material is shared under the 
        <a href="https://creativecommons.org/licenses/by/4.0">
            CC-BY License.
        </a>
    </footer>
</html>
